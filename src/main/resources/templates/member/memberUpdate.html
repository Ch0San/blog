<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <title>정보수정</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}" />
</head>
<script th:src="@{/js/memberUpdate.js}"></script>

<body>
    <!-- 공통 헤더 import -->
    <div th:replace="~{fragments/header :: header('home')}"></div>

    <main class="container" style="padding-top:28px;padding-bottom:40px">
        <div class="write-form">
            <h1 style="margin-top:0;margin-bottom:10px;color:var(--text)">회원정보 수정</h1>
            <p style="margin-bottom:30px;color:var(--muted);font-size:14px">회원님의 정보를 수정하실 수 있습니다.</p>

            <!-- 수정 성공 메시지 -->
            <div th:if="${param.success}"
                style="background:#f0f9ff;border:1px solid #bae7ff;color:#0958d9;padding:12px;border-radius:6px;margin-bottom:20px;font-size:14px">
                회원정보가 성공적으로 수정되었습니다.
            </div>

            <!-- 수정 실패 메시지 -->
            <div th:if="${param.error}"
                style="background:#fff1f0;border:1px solid #ffccc7;color:#cf1322;padding:12px;border-radius:6px;margin-bottom:20px;font-size:14px">
                정보 수정에 실패했습니다. 다시 시도해주세요.
            </div>

            <form th:action="@{/member/update}" method="post" th:object="${member}">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                <div class="form-group">
                    <label for="username">아이디</label>
                    <input type="text" id="username" th:field="*{username}" disabled
                        style="background:#f5f7fb;cursor:not-allowed">
                    <small style="color:var(--muted);font-size:12px">아이디는 변경할 수 없습니다.</small>
                </div>

                <div class="form-group">
                    <label for="currentPassword">현재 비밀번호</label>
                    <input type="password" id="currentPassword" name="currentPassword" placeholder="현재 비밀번호를 입력하세요"
                        required>
                    <small style="color:var(--muted);font-size:12px">정보 수정을 위해 현재 비밀번호를 입력해주세요.</small>
                </div>

                <div class="form-group">
                    <label for="password">새 비밀번호</label>
                    <input type="password" id="password" name="password" placeholder="변경할 비밀번호 (입력 시에만 변경)"
                        minlength="8">
                    <small style="color:var(--muted);font-size:12px">비밀번호를 변경하지 않으려면 비워두세요. (8자 이상)</small>
                </div>

                <div class="form-group">
                    <label for="passwordConfirm">새 비밀번호 확인</label>
                    <input type="password" id="passwordConfirm" name="passwordConfirm" placeholder="새 비밀번호 확인"
                        minlength="8">
                </div>

                <div class="form-group">
                    <label for="email">이메일 <span style="color:#ff4444">*</span></label>
                    <input type="email" id="email" th:field="*{email}" placeholder="example@email.com" required>
                </div>

                <div class="form-group">
                    <label for="phoneNumber">전화번호</label>
                    <input type="tel" id="phoneNumber" th:field="*{phoneNumber}" placeholder="010-1234-5678"
                        pattern="[0-9]{2,3}-[0-9]{3,4}-[0-9]{4}">
                    <small style="color:var(--muted);font-size:12px">형식: 010-1234-5678</small>
                </div>

                <div class="form-group">
                    <label for="address">주소</label>
                    <input type="text" id="address" th:field="*{address}" placeholder="주소를 입력하세요">
                </div>

                <div class="form-actions"
                    style="display:flex;align-items:center;justify-content:space-between;margin-top:16px">
                    <div class="left-actions">
                        <button type="button" class="btn"
                            style="background:#fff1f0;color:#cf1322;border:1px solid #ffccc7"
                            onclick="deleteMember()">회원 탈퇴</button>
                    </div>
                    <div class="right-actions" style="display:flex;gap:8px">
                        <a href="/" class="btn btn-secondary">취소</a>
                        <button type="submit" class="btn btn-primary">정보 수정</button>
                    </div>
                </div>
            </form>
        </div>
    </main>

    <div th:replace="~{fragments/footer :: footer}"></div>

    <script>
        // 새 비밀번호 확인 검증
        document.querySelector('form').addEventListener('submit', function (e) {
            const password = document.getElementById('password').value;
            const passwordConfirm = document.getElementById('passwordConfirm').value;

            // 새 비밀번호를 입력한 경우에만 확인
            if (password || passwordConfirm) {
                if (password !== passwordConfirm) {
                    e.preventDefault();
                    alert('새 비밀번호가 일치하지 않습니다.');
                    document.getElementById('passwordConfirm').focus();
                    return false;
                }
            }
        });

        // 회원 탈퇴 함수
        function deleteMember() {
            if (confirm('정말로 회원 탈퇴하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/member/delete';

                const csrfToken = document.querySelector('meta[name="_csrf"]').content;
                const input = document.createElement('input');
                input.type = 'hidden';
                // Spring Security 기본 파라미터명 사용
                input.name = '_csrf';
                input.value = csrfToken;

                form.appendChild(input);
                document.body.appendChild(form);
                form.submit();
            }
        }
    </script>
</body>

</html>