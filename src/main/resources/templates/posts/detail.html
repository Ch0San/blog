<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <title th:text="${post.title}">게시글 제목</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <!-- Kakao Maps SDK: 키는 전역 모델 kakaoJsKey 에서 주입 (https 명시) -->
    <script th:src="@{'https://dapi.kakao.com/v2/maps/sdk.js'(appkey=${kakaoJsKey}, libraries='services')}"></script>
    <script th:src="@{/js/posts/detail.js}" defer></script>
</head>

<body>
    <!-- 공통 헤더 import -->
    <div th:replace="~{fragments/header :: header('posts')}"></div>

    <main class="container" style="padding-top:28px;padding-bottom:40px">
        <article class="post-detail">
            <!-- 게시글 헤더 -->
            <header class="post-header">
                <div class="post-category" th:if="${post.category}" th:text="${post.category}">카테고리</div>
                <h1 class="post-title" th:text="${post.title}">게시글 제목</h1>

                <div class="post-meta-info">
                    <span class="author" th:text="${post.author}">작성자</span>
                    <span class="separator">·</span>
                    <span class="date" th:text="${#temporals.format(post.createdAt, 'yyyy년 MM월 dd일')}">2025년 10월
                        26일</span>
                    <span class="separator">·</span>
                    <span class="views">👁️ <span th:text="${post.viewCount}">0</span></span>
                    <span class="separator">·</span>
                    <span class="likes">❤️ <span id="likeCount" th:text="${post.likeCount}">0</span></span>
                    <!-- 좋아요 버튼 (로그인 사용자만) -->
                    <span class="separator" sec:authorize="isAuthenticated()">·</span>
                    <button type="button" id="likeBtn" sec:authorize="isAuthenticated()" th:data-post-id="${post.id}"
                        th:data-is-liked="${isLiked}" class="btn-like" th:classappend="${isLiked} ? 'liked' : ''"
                        style="background:none;border:none;cursor:pointer;color:#e74c3c;font-size:14px">
                        <span id="likeBtnText" th:text="${isLiked} ? '❤️ 좋아요 취소' : '🤍 좋아요'">🤍 좋아요</span>
                    </button>
                </div>

                <!-- 공유 버튼 -->
                <div class="share-buttons">
                    <button type="button" class="share-btn" onclick="copyCurrentUrl()">🔗 링크 복사</button>
                    <button type="button" class="share-btn" onclick="shareToTwitter()">🐦 트윗</button>
                    <button type="button" class="share-btn" onclick="shareToFacebook()">f 공유</button>
                </div>

                <!-- 태그 -->
                <div class="post-tags" th:if="${post.tags}">
                    <span class="tag" th:each="tag : ${#strings.arraySplit(post.tags, ',')}" th:text="'#' + ${tag}">
                        #태그
                    </span>
                </div>
            </header>

            <!-- 게시글 본문 -->
            <div class="post-content" th:utext="${post.content}">
                게시글 내용이 여기에 표시됩니다.
            </div>

            <!-- 첨부파일 다운로드 섹션 -->
            <div class="attachments-section" th:if="${attachments != null and attachments.size() > 0}"
                style="margin-top:30px;padding:20px;background:#f8f9fa;border-radius:8px;border:1px solid #e9ecef">
                <h4 style="margin:0 0 16px 0;color:var(--text);font-size:16px;font-weight:600">
                    📎 첨부파일 (<span th:text="${attachments.size()}">0</span>개)
                </h4>
                <div class="attachment-list" style="display:flex;flex-direction:column;gap:10px">
                    <div class="attachment-item" th:each="image, iterStat : ${attachments}"
                        th:with="filename=${image.imageUrl != null ? (image.imageUrl.contains('/') ? image.imageUrl.substring(image.imageUrl.lastIndexOf('/') + 1) : image.imageUrl) : 'file'},
                              ext=${filename.contains('.') ? filename.substring(filename.lastIndexOf('.') + 1).toLowerCase() : ''},
                              displayName=${image.caption != null and !#strings.isEmpty(image.caption) ? image.caption : filename}"
                        style="display:flex;align-items:center;justify-content:space-between;padding:12px;background:white;border-radius:6px;border:1px solid #dee2e6">
                        <div style="display:flex;align-items:center;gap:12px;flex:1;min-width:0">
                            <span style="font-size:20px"
                                th:text="${ext == 'zip' or ext == 'rar' or ext == '7z' ? '📦' : (ext == 'pdf' ? '📄' : (ext == 'doc' or ext == 'docx' ? '📝' : (ext == 'xls' or ext == 'xlsx' ? '📊' : '📎')))}">�</span>
                            <div style="flex:1;min-width:0">
                                <div style="font-weight:500;color:var(--text);font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis"
                                    th:text="${displayName}">
                                    파일명
                                </div>
                                <div style="font-size:12px;color:var(--muted);margin-top:2px">
                                    <span th:text="${ext.toUpperCase()}">확장자</span>
                                </div>
                            </div>
                        </div>
                        <a th:href="@{/posts/download(filename=${filename})}" class="btn btn-primary"
                            style="padding:8px 16px;font-size:13px;white-space:nowrap;text-decoration:none" download>
                            💾 다운로드
                        </a>
                    </div>
                </div>
            </div>
            </div>

            <!-- 게시글 액션 버튼 -->
            <div class="post-actions">
                <a href="/posts" class="btn btn-secondary">목록으로</a>
                <div class="action-buttons" sec:authorize="hasRole('ADMIN')">
                    <a th:href="@{'/posts/edit/' + ${post.id}}" class="btn btn-primary">수정</a>
                    <form th:action="@{'/posts/delete/' + ${post.id}}" method="post" style="display:inline"
                        onsubmit="return confirm('정말 삭제하시겠습니까?')">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <button type="submit" class="btn btn-danger">삭제</button>
                    </form>
                </div>
            </div>

            <!-- 댓글 영역 -->
            <section class="comments-section">
                <h3 class="comments-title">
                    댓글 <span class="comment-count" th:text="${comments != null ? comments.size() : 0}">0</span>
                </h3>

                <!-- 댓글 목록 -->
                <div class="comments-list">
                    <!-- 댓글 없을 때 -->
                    <div class="no-comments" th:if="${comments == null || comments.size() == 0}">
                        <p>첫 댓글을 작성해보세요!</p>
                    </div>
                    <div class="comment-item" th:each="comment : ${comments}" th:if="${!comment.deleted}">
                        <div class="comment-header">
                            <span class="comment-author" th:text="${comment.author}">작성자</span>
                            <span class="comment-date"
                                th:text="${#temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm')}">날짜</span>
                        </div>

                        <!-- 댓글 내용 (기본 표시) -->
                        <div class="comment-content" th:id="'comment-content-' + ${comment.id}"
                            th:text="${comment.content}">댓글 내용</div>

                        <!-- 댓글 수정 폼 (숨김 상태) -->
                        <div class="comment-edit-form" th:id="'comment-edit-form-' + ${comment.id}"
                            style="display:none">
                            <form th:action="@{'/comments/' + ${comment.id} + '/update'}" method="post">
                                <input type="hidden" name="postId" th:value="${post.id}" />
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                <textarea name="content" th:text="${comment.content}" rows="3" required
                                    style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;resize:vertical"></textarea>
                                <div style="margin-top:8px;display:flex;gap:8px">
                                    <button type="submit" class="btn btn-primary"
                                        style="font-size:13px;padding:6px 12px">저장</button>
                                    <button type="button" class="btn btn-secondary"
                                        style="font-size:13px;padding:6px 12px"
                                        th:onclick="'cancelEdit(' + ${comment.id} + ')'">취소</button>
                                </div>
                            </form>
                        </div>

                        <div class="comment-actions">
                            <span class="comment-like">❤️ <span th:id="'comment-like-count-' + ${comment.id}"
                                    th:text="${comment.likeCount}">0</span></span>
                            <!-- 댓글 좋아요 버튼 (로그인 사용자만) -->
                            <button type="button" sec:authorize="isAuthenticated()" class="btn-comment-like"
                                th:id="'comment-like-btn-' + ${comment.id}" th:data-comment-id="${comment.id}"
                                th:data-is-liked="${likedCommentIds != null and likedCommentIds.contains(comment.id)}"
                                style="background:none;border:none;cursor:pointer;color:#e74c3c;font-size:12px;margin-left:8px">
                                <span th:id="'comment-like-text-' + ${comment.id}"
                                    th:text="${likedCommentIds != null and likedCommentIds.contains(comment.id)} ? '좋아요 취소' : '좋아요'">
                                    좋아요
                                </span>
                            </button>
                            <!-- 본인 댓글 수정/삭제 버튼 (아이디 기준 비교) -->
                            <span sec:authorize="isAuthenticated()"
                                th:if="${#authentication.name == comment.authorUsername}">
                                <button type="button" class="btn-edit-comment"
                                    th:onclick="'editComment(' + ${comment.id} + ')'"
                                    style="background:none;border:none;cursor:pointer;color:#888;font-size:12px;margin-left:8px">수정</button>
                                <form th:action="@{'/comments/' + ${comment.id} + '/delete'}" method="post"
                                    style="display:inline" onsubmit="return confirm('댓글을 삭제하시겠습니까?')">
                                    <input type="hidden" name="postId" th:value="${post.id}" />
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                    <button type="submit" class="btn-delete-comment"
                                        style="background:none;border:none;cursor:pointer;color:#888;font-size:12px;margin-left:8px">삭제</button>
                                </form>
                            </span>
                        </div>
                    </div>

                </div>

                <!-- 댓글 작성 폼 (로그인 사용자만) -->
                <div class="comment-form-wrapper" sec:authorize="isAuthenticated()" style="margin-top: 40px;">
                    <form class="comment-form" th:action="@{'/posts/' + ${post.id} + '/comments'}" method="post">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <textarea name="content" placeholder="댓글을 입력하세요..." rows="3" required></textarea>
                        <button type="submit" class="btn btn-primary">댓글 작성</button>
                    </form>
                </div>

                <!-- 비로그인 시 안내 -->
                <div class="login-notice" sec:authorize="!isAuthenticated()" style="margin-top: 40px;">
                    <p>댓글을 작성하려면 <a href="/member/signin">로그인</a>이 필요합니다.</p>
                </div>
            </section>

            <!-- 최신글 목록 -->
            <section class="related-posts-section" th:if="${recentPosts != null && recentPosts.size() > 0}">
                <h3 class="section-title">최신 글</h3>
                <div class="related-posts-grid">
                    <a th:each="recentPost : ${recentPosts}" th:href="@{'/posts/' + ${recentPost.id}}"
                        class="related-post-card">
                        <div class="related-post-thumbnail" th:if="${recentPost.thumbnailUrl}">
                            <img th:src="@{${recentPost.thumbnailUrl}}" th:alt="${recentPost.title}" />
                        </div>
                        <div class="related-post-thumbnail placeholder" th:unless="${recentPost.thumbnailUrl}">
                            <span>📝</span>
                        </div>
                        <div class="related-post-content">
                            <h4 class="related-post-title" th:text="${recentPost.title}">게시글 제목</h4>
                            <div class="related-post-meta">
                                <span
                                    th:text="${#temporals.format(recentPost.createdAt, 'yyyy.MM.dd')}">2025.10.27</span>
                                <span class="dot">·</span>
                                <span>👁️ <span th:text="${recentPost.viewCount}">0</span></span>
                            </div>
                        </div>
                    </a>
                </div>
            </section>
        </article>
    </main>



    <div th:replace="~{fragments/footer :: footer}"></div>
</body>

</html>